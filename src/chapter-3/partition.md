

# 分区

为了对存储设备进行数字划分和管理，人们创造了分区的概念。作为动词，分区将磁盘的数字空间划分出不同功能和大小的区域；作为名词，分区指的的是划分出的区域。

## 基本概念

### 扇区

扇区将存储空间划分成一个个块，并给块编号，块的编号也就是扇区的地址

#### 物理扇区

此处的物理扇区指的是一个存储设备所能访问的最小的存储单元。一般物理扇区由存储设备的硬件和固件所决定，如三星PM981A固态硬盘的物理扇区大小为4096Bytes。



### 分区表

分区表又可称为存储设备分区形式、分区结构，一般有MBR和GPT两种。分区表用于记录在设备上的各个分区的位置，分区承载了何种文件系统，告知主板固件每个分区承载何种功能，存储启动代码等等。

#### MBR

MBR即主引导记录，英文全名为Master Boot Record，占据存储设备起始的512Bytes的空间。特点是适合2TiB以下的硬盘，如果是启动系统的硬盘需要根据主板的固件进行选择，一般较老的电脑(运行Windows XP/2000/2003等一般不支持GPT分区表的系统)使用MBR。

这里介绍MBR的经典表结构。

##### MBR表结构

| 起始地址 | 内容       | 描述                           | 大小(Bytes) |
| -------- | ---------- | ------------------------------ | ----------- |
| 0        | Bootloader | 存放引导程序代码               | 446         |
| 446      | 分区条目1  | 分区条目说明分区信息，包括     | 16          |
| 462      | 分区条目2  | 分区的位置、大小、可引导等信息 | 16          |
| 478      | 分区条目3  | 四个分区条目说明               | 16          |
| 494      | 分区条目4  | MBR内只能存放四个分区信息      | 16          |
| 510      | 0x55       | 55和AA是16进制表示的启动签名   | 1           |
| 511      | 0xAA       | 用于验证MBR完整性              | 1           |
|          |            |                                | 512         |

注：上表的引导程序即Bootloader，具有读入和加载分区的引导扇区的功能；分区的引导扇区，将会读入根目录，加载分区引导程序如Ntldr；分区引导程序具有读取此分区文件系统的能力，文件分区引导程序将会读入引导菜单文件，列出操作系统菜单，同时加载引导操作系统启动的核心驱动程序文件。

##### 分区条目表结构

| 起始地址 | 内容         | 描述                                                         | 大小(Bytes) |
| -------- | ------------ | ------------------------------------------------------------ | ----------- |
| 0        | 活动标记     | 决定分区是否为活动分区                                       | 1           |
| 1        | 起始扇区地址 | 分区第一个扇区的地址，用于定位分区位置                       | 3           |
| 4        | 分区类型     | 标记分区的[类型](https://en.wikipedia.org/wiki/Partition_type) | 1           |
| 5        | 结束扇区地址 | 分区最后一个扇区的地址，用于定位分区位置                     | 3           |
| 8        | LBA          | 该分区第一个扇区的绝对块(LBA)地址                            | 4           |
| 12       | 扇区数       | 分区中的总共扇区数量                                         | 4           |
|          |              |                                                              | 16          |

注：上表的超过1Byte均为小端序，小端序是一种处理字节的顺序，决定以何种方向来处理多个字节，小端序就是对于多个Byte的读写顺序以反向的一个一个Byte读入，可以参考[Endianness](https://en.wikipedia.org/wiki/Endianness)


#### GPT

GPT即GUID分区表，英文全名为GUID Partition Table。GPT分区表的特点是相比MBR的32位扇区，GPT扩展到64位扇区，可以支持最大支持$2^{64}*512 Byte= 8 ZiB$的硬盘容量大小，如果是启动系统的硬盘需要根据主板的固件进行选择，一般较新的电脑(运行Windows 8/10等支持GPT分区表和UEFI启动的系统)使用GPT。

GPT分区表由特殊MBR+主GPT表+第二GPT表构成。

- 特殊MBR可以是保护性的MBR，用于防止不识别GPT分区表的操作系统和软件对其进行错误修改；也可以是更短的MBR启动代码，用于同时支持UEFI和BIOS固件，特殊MBR位于存储设备起始第一个扇区
- 主GPT表和第二GPT表存储相同的内容。主GPT表从特殊MBR之后开始存储，第二GPT表是主GPT表的备份，位于硬盘的扇区末尾。

### 分区类型-不同的分区功能

可以依据分区承载的功能不同来划分分区的类型

以Windows系统为例，分区可以分为系统分区、恢复分区、Windows分区和数据分区。

- 系统分区：存放用于系统启动、系统级加解密(Bitlocker)等维持操作系统运行、修复的文件和数据的分区，如EFI分区、MSR分区
- 恢复分区：存放用于修复系统、恢复出厂设置等在系统无法启动的情况下恢复系统可运行状态所需文件和数据的分区，如Recovery分区
- Windows分区：存放Windows操作系统文件，支持操作系统运行的分区，一般指的”C盘“就是此分区
- 数据分区：存放个人文件等无关系统启动、恢复、运行的分区

### 分区类型-文件系统格式

文件系统格式又称文件系统类型，可以依据文件系统格式的不同来划分分区的类型，不同的文件系统格式往往意味着不同的特性和功能。

常见的文件系统格式有:

- FAT家族:FAT12,FAT16,FAT32,FAT64(exFAT)
- NTFS
- ext家族:ext,ext2,ext3,ext4
- zfs
- xfs
- brtfs
- ReFS

本文介绍FAT32、exFAT、NTFS这三种文件系统

### 盘符

盘符又称为驱动器号，是当前操作系统指派的用于访问某个分区的符号，比如Windows习惯将当前运行的Windows分区指派”C“，也就是”C盘“的来源，可以通过磁盘管理对盘符进行删除和分配(Windows为了保护系统，禁止修改系统分区和Windows分区的盘符)，盘符只在当前系统下具有意义，如在一个资源管理器下显示了四个分区的系统下插入一个优盘，盘符可能与资源管理器下显示了一个分区的系统下插入一个优盘的盘符分配不同。

### 重命名

重命名是对一个分区(卷标)进行重新命名的操作，比如将”C盘“命名为”Windows“，分区的名字不会因为访问分区的系统不同而改变，比如给一个优盘的一个分区起名为”新加卷“，那么当这个优盘被插入到其他电脑上，也会显示为”新加卷“

### 格式化

(高级)格式化是对分区进行初始化的操作，将会导致这个分区的文件将不再可以被文件系统访问。在格式化的时候可以对文件系统进行配置



## 使用磁盘管理程序进行分区



## 进阶

警告：如果没有充分考虑每个操作可能产生的后果，请预先在不重要的设备或虚拟机中进行操作，不正确的操作和操作序列可能导致文件不可逆的丢失和系统损坏。

### 使用Diskpart命令行程序进行分区



### 使用易数Diskgenius或傲梅分区助手软件进行分区

#### 易数Diskgenius

[官方网站](www.diskgenius.cn)

#### 傲梅分区助手

[官方网站](www.disktool.cn)



## 参考资料

- [Master_Boot_Record](https://en.wikipedia.org/wiki/Master_Boot_Record)
- [[科普] 终于明白什么叫 55 AA 了](http://bbs.mydigit.cn/read.php?tid=597024)
- [hard-drives-and-partitions](https://docs.microsoft.com/en-us/windows-hardware/manufacture/desktop/hard-drives-and-partitions)
- [深入解析Windows操作系统 第四版](https://book.douban.com/subject/2031396/)

